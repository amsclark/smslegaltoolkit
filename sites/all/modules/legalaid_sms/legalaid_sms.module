<?php


/**
 * Implements hook_form().
 */

/**
 * Implements hook_twilio_sms_incoming().
 */
function legalaid_sms_twilio_sms_incoming($sms, $options) {
  $number = $sms['number'];
  $number_twilio = $sms['number_twilio'];
  $message = strtolower($sms['message']);
  watchdog('SMS','An sms was received from @num',array('@num' => $number),WATCHDOG_NOTICE);

  $exact_match = legalaid_sms_find_match($message);
  if (!empty($exact_match)) {
    watchdog('SMS','We found a match',array(),WATCHDOG_NOTICE);

    twilio_send($number, 'We found a match');
  }
  else {
    watchdog('SMS','No match',array(),WATCHDOG_NOTICE);

    twilio_send($number, 'We did not find a match');
  }

}


function legalaid_sms_find_match($message) {
  $query = new entityFieldQuery();
  $query->entityCondition('entity_type','node')
    ->propertyCondition('status',NODE_PUBLISHED)
    ->propertyCondition('type','sms_info')
  ->fieldCondition('field_keyword','value',$message,'=')
    ->addMetaData('account', user_load(1));

$result = $query->execute();
if (isset($result['node'])) {
  $matching_items_nids = array_keys($result['node']);
  $matching_items = entity_load('node', $matching_items_nids);
  return $matching_items;
}
return null;



}

/**
 * Implements hook_form_alter().
 */
function legalaid_sms_form_alter(&$form, &$form_state, $form_id) {

}


function legalaid_sms_strip_html($text) {
    $text = str_replace('[no-lexicon]','', $text);
    $text = str_replace('[/no-lexicon]','', $text);
    $text = str_replace('<a href="/node',' http://dev-hackathon-sms.pantheonsite.io/node',$text);
    $text = str_replace('<a href="es/node',' http://dev-hackathon-sms.pantheonsite.io/es/node',$text);
    $text = str_replace('<a href="',' ',$text);
    $text = str_replace('">',' ',$text);
    $text = str_replace('<p>'," \n ",$text);
    $text = str_replace('<h3>'," \n ",$text);
    $text = str_replace('<h4>'," \n ",$text);
    $text = str_replace('<h5>'," \n ",$text);
    $text = str_replace('&nbsp;'," ",$text);
    $text = str_replace('<li>'," \n*",$text);
    $text = str_replace('<ul>'," \n",$text);
    $text = decode_entities($text);


    $text = strip_tags($text);
    return $text;
  }
}