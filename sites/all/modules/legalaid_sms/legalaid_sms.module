<?php


/**
 * Implements hook_form().
 */

/**
 * Implements hook_twilio_sms_incoming().
 */
function legalaid_sms_twilio_sms_incoming($number, $number_twilio, $message) {
  watchdog('SMS','An sms was received from @num',array('@num' => $number),WATCHDOG_NOTICE);

  $message = strtolower($message);
  $exact_match = legalaid_sms_find_match($message);
  if (!empty($exact_match)) {
    twilio_send($number, 'We found a match');
  }
  else {
    if (module_exists('houston_ai')) {
      $problem = houston_ai_classify('',$message,'');
    }
    twilio_send($number, 'We did not find a match');
  }

}


function legalaid_sms_find_match($message) {
  $query = new entityFieldQuery();
  $query->entityCondition('entity_type','node')
    ->property_condition('status',NODE_PUBLISHED)
    ->property_condition('type','sms_info')
  ->field_condition('field_keyword','value',$message,'=')
    ->addMetaData('account', user_load(1));

$result = $query->execute();
if (isset($result['node'])) {
  $matching_items_nids = array_keys($result['node']);
  $matching_items = entity_load('node', $matching_items_nids);
  return $matching_items;
}
return null;



}